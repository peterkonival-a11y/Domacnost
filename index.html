<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rodinne financie</title>

<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3399ff">

<style>
body{font-family:Arial,sans-serif;background:#121826;color:#f0f0f0;margin:0;padding:10px}
h1,h2,h3{text-align:center;color:#99ccff;margin:5px 0}
.box{background:#1f2233;padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid #333}
input,select,button{width:100%;padding:8px;margin:5px 0;border-radius:6px;border:1px solid #555;background:#2a2f44;color:#f0f0f0}
button{font-size:16px;background:#3399ff;color:#fff;border:none;cursor:pointer}
button:hover{background:#2277cc}
.income{color:#00ff99;font-weight:bold}
.expense{color:#ff3333;font-weight:bold}
.month-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.month-card{border:1px solid #444;border-radius:10px;padding:10px;background:#2a2f44}
.month-card h4{text-align:center;margin:6px 0;color:#99ccff}
.row{display:flex;justify-content:space-between;gap:10px}
.records-table{display:flex;flex-direction:column;gap:6px}
.record-row{display:flex;gap:6px;align-items:center}
.record-row input, .record-row span{border:1px solid #555;padding:4px;border-radius:4px;background:#2a2f44;color:#f0f0f0}
.record-row input[type=checkbox]{width:20px;height:20px;margin:0}
.record-row span{flex:1;text-align:left}
.record-row span.amount{width:80px;text-align:right}
.actions{margin-top:10px;text-align:right}
.tab{display:flex;cursor:pointer;gap:10px;margin-bottom:10px}
.tab button{flex:1;padding:10px;background:#2a2f44;color:#99ccff;border:none;border-radius:5px}
.tab button.active{background:#3399ff;color:#fff;font-weight:bold}
.tab-content{display:none}
.tab-content.active{display:block}
canvas{max-width:100%;height:300px;background:#1f2233;border-radius:10px}
.autocomplete-input{width:100%;padding:6px;background:#2a2f44;color:#f0f0f0}
.suggestions{border:1px solid #555;background:#2a2f44;position:absolute;z-index:1000;max-height:150px;overflow-y:auto;color:#f0f0f0}
.suggestions div{padding:4px;cursor:pointer}
.suggestions div:hover{background:#505773}
.record-row button{width:auto;padding:2px 6px;font-size:12px;background:#cc3333;color:#fff;border:none;border-radius:4px;cursor:pointer}
.record-row button:hover{background:#aa0000}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>

<h1>Rodinne financie</h1>

<div class="tab">
  <button class="active" onclick="openTab(event,'prehlad')">Prehlad</button>
  <button onclick="openTab(event,'rocny')">Rocny prehlad</button>
  <button onclick="openTab(event,'grafy')">Grafy</button>
</div>

<!-- Prehlad - aktualny mesiac -->
<div id="prehlad" class="tab-content active">

  <div class="box">
    <h2>Pridat zaznam</h2>
    <label for="date">Kalendar:</label>
    <input type="date" id="date">
    <select id="type">
      <option value="expense">Vydavok</option>
      <option value="income">Prijem</option>
    </select>
    <select id="category">
      <option>Byvanie & energie:</option>
      <option>Potraviny & Domacnost:</option>
      <option>Doprava:</option>
      <option>Osobne vydavky & Starostlivost</option>
      <option>Deti & Vzdelavanie:</option>
      <option>Volny cas & Zabava</option>
      <option>Ostatne</option>
    </select>
    <input type="text" id="itemInput" placeholder="Polozka">
    <input type="number" id="amount" placeholder="Suma (EUR)">
    <button onclick="saveRecord()">Ulozit</button>
  </div>

  <!-- Opakujuce sa platby -->
  <div class="box">
    <h2>Opakujuce sa platby</h2>
    <input type="text" id="recItem" placeholder="Polozka">
    <select id="recCategory">
      <option>Ostatne</option>
    </select>
    <input type="number" id="recAmount" placeholder="Suma (EUR)">
    <label>Od:</label><input type="month" id="recStart">
    <label>Do (volitelne):</label><input type="month" id="recEnd">
    <select id="recFrequency">
      <option value="monthly">Mesacne</option>
      <option value="weekly">Tyzdne</option>
    </select>
    <button onclick="addRecurring()">Pridat opakujucu sa platbu</button>
    <div id="recurringList" class="records-table"></div>
  </div>

  <div class="box">
    <h2>Aktualny mesiac</h2>
    <select id="monthFilter" onchange="render()"></select>
    <div style="margin-top:5px;">
      Prijmy: <span id="monthIncome" class="income">0.00 EUR</span> | 
      Vydavky: <span id="monthExpense" class="expense">0.00 EUR</span>
    </div>
    <div id="records" class="records-table"></div>
    <div class="actions"><button onclick="deleteSelected()">Vymaz oznacene</button></div>
    <button onclick="exportXLSX()">Export do Excel (.xlsx)</button>
  </div>
</div>

<!-- Rocny prehlad - vsetky mesiace -->
<div id="rocny" class="tab-content">
  <div class="box">
    <h2>Rocny prehlad</h2>
    <select id="yearSelect" onchange="renderRocny()"></select>
    <div id="yearSummary" class="month-grid"></div>
    <h3>Celkom za rok: <span id="yearTotal">0 EUR</span></h3>
  </div>
</div>

<!-- Grafy -->
<div id="grafy" class="tab-content">
  <div class="box">
    <h2>Graf prijmov a vydavkov</h2>
    <select id="monthChartSelect" onchange="drawChart()"></select>
    <canvas id="chart"></canvas>
  </div>
</div>

<script>
const monthNames=['Januar','Februar','Marec','April','Maj','Jun','Jul','August','September','Oktober','November','December'];
let records=JSON.parse(localStorage.getItem('records'))||[];
let categoryItems=JSON.parse(localStorage.getItem('categoryItems'))||{};
let recurringRecords=JSON.parse(localStorage.getItem('recurringRecords'))||[];
let chartInstance=null;

const yearSelect=document.getElementById('yearSelect');
const monthFilter=document.getElementById('monthFilter');
const yearSummary=document.getElementById('yearSummary');
const yearTotalEl=document.getElementById('yearTotal');
const recordsDiv=document.getElementById('records');
const monthIncomeEl=document.getElementById('monthIncome');
const monthExpenseEl=document.getElementById('monthExpense');
const monthChartSelect=document.getElementById('monthChartSelect');

function openTab(evt, tabName){
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.tab button').forEach(b=>b.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  evt.currentTarget.classList.add('active');
  if(tabName==='grafy') drawChart();
  if(tabName==='rocny') renderRocny();
}

function saveRecord(){
  const r={date:date.value,type:type.value,category:category.value,item:itemInput.value,amount:parseFloat(amount.value)};
  if(!r.date||!r.amount||!r.item){alert('Vypln vsetky udaje');return}
  records.push(r);
  if(!categoryItems[r.category]) categoryItems[r.category]=[];
  if(!categoryItems[r.category].includes(r.item)) categoryItems[r.category].push(r.item);
  localStorage.setItem('categoryItems',JSON.stringify(categoryItems));
  localStorage.setItem('records',JSON.stringify(records));
  amount.value=''; itemInput.value='';
  initSelectors();
  render();
}

// inicializacia vyberu mesiacov a rokov
function initSelectors(){
  const years=[...new Set(records.map(r=>r.date.slice(0,4)))].sort();
  if(!years.includes(String(new Date().getFullYear()))) years.push(String(new Date().getFullYear()));
  yearSelect.innerHTML=''; years.forEach(y=>{const o=document.createElement('option'); o.value=y; o.textContent=y; yearSelect.appendChild(o);});
  yearSelect.value=String(new Date().getFullYear());

  monthFilter.innerHTML=''; monthChartSelect.innerHTML='';
  for(let m=1;m<=12;m++){
    const monthStr=yearSelect.value+'-'+String(m).padStart(2,'0');
    const o1=document.createElement('option'); o1.value=monthStr; o1.textContent=monthNames[m-1]+' '+yearSelect.value; monthFilter.appendChild(o1);
    const o2=o1.cloneNode(true); monthChartSelect.appendChild(o2);
  }
  monthFilter.value=new Date().toISOString().slice(0,7);
}
yearSelect.onchange=()=>{renderRocny(); initSelectors(); render();}
monthFilter.onchange=render;

// render aktualny mesiac
function render(){
  const selectedMonth=monthFilter.value;
  let inc=0,exp=0;
  recordsDiv.innerHTML='';

  records.forEach((r,i)=>{
    if(!r.date.startsWith(selectedMonth)) return;
    r.type==='income'?inc+=r.amount:exp+=r.amount;
    const div=document.createElement('div');
    div.className='record-row '+r.type; div.dataset.index=i;
    div.innerHTML=`<input type='checkbox' class='record-check'><span class='desc'>${r.category} - ${r.item}</span><span class='amount'>${r.amount} EUR</span>`;
    recordsDiv.appendChild(div);
  });

  recurringRecords.forEach(r=>{
    if(selectedMonth>=r.start && (!r.end || selectedMonth<=r.end)){
      if(r.frequency==='monthly') exp+=r.amount;
      const div=document.createElement('div');
      div.className='record-row expense';
      div.innerHTML=`<span class='desc'>${r.category} - ${r.item} (recurring)</span><span class='amount'>${r.amount} EUR</span>`;
      recordsDiv.appendChild(div);
    }
  });

  monthIncomeEl.innerText=inc.toFixed(2)+' EUR';
  monthExpenseEl.innerText=exp.toFixed(2)+' EUR';
}

// render rocny prehlad - vsetky mesiace
function renderRocny(){
  let yearTotal=0;
  yearSummary.innerHTML='';
  const year=yearSelect.value;
  for(let i=0;i<12;i++){
    let inc=0,exp=0;
    records.forEach(r=>{
      const d=new Date(r.date);
      if(d.getFullYear()==year && d.getMonth()==i) r.type==='income'?inc+=r.amount:exp+=r.amount;
    });
    recurringRecords.forEach(r=>{
      const monthStr=year+'-'+String(i+1).padStart(2,'0');
      if(monthStr>=r.start && (!r.end || monthStr<=r.end)) if(r.frequency==='monthly') exp+=r.amount;
    });
    yearSummary.innerHTML+=`<div class="month-card"><h4>${monthNames[i]}</h4><div class="row"><span>Prijmy</span><span class="income">${inc.toFixed(2)}</span></div><div class="row"><span>Vydavky</span><span class="expense">${exp.toFixed(2)}</span></div></div>`;
    yearTotal+=inc-exp;
  }
  yearTotalEl.innerText=yearTotal.toFixed(2)+' EUR';
}

// opakujuce sa platby
function addRecurring(){
  const r={item:recItem.value,category:recCategory.value,amount:parseFloat(recAmount.value),frequency:recFrequency.value,start:recStart.value,end:recEnd.value};
  if(!r.item||!r.amount||!r.start){alert('Vypln vsetky udaje');return;}
  recurringRecords.push(r);
  localStorage.setItem('recurringRecords',JSON.stringify(recurringRecords));
  recItem.value=''; recAmount.value=''; recStart.value=''; recEnd.value='';
  renderRecurring(); render();
}
function renderRecurring(){
  const div=document.getElementById('recurringList'); div.innerHTML='';
  recurringRecords.forEach((r,i)=>{
    const row=document.createElement('div');
    row.className='record-row'; row.dataset.index=i;
    row.innerHTML=`<span class='desc'>${r.category} - ${r.item}</span><span class='amount'>${r.amount} EUR</span><span>${r.frequency}</span><button onclick="deleteRecurring(${i})">X</button>`;
    div.appendChild(row);
  });
}
function deleteRecurring(idx){recurringRecords.splice(idx,1); localStorage.setItem('recurringRecords',JSON.stringify(recurringRecords)); renderRecurring();}

// mazanie a export
function deleteSelected(){
  const checkboxes=document.querySelectorAll('#records .record-check');
  const indexesToDelete=[];
  checkboxes.forEach(cb=>{if(cb.checked) indexesToDelete.push(Number(cb.parentElement.dataset.index));});
  indexesToDelete.sort((a,b)=>b-a).forEach(idx=>{records.splice(idx,1);});
  localStorage.setItem('records',JSON.stringify(records));
  render();
}
function exportXLSX(){
  if(records.length===0){alert('Ziadne zaznamy na export'); return;}
  const wb=XLSX.utils.book_new();
  const ws_data=[['Datum','Typ','Kategorie','Polozka','Suma']];
  records.forEach(r=>ws_data.push([r.date,r.type,r.category,r.item,r.amount]));
  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,'Financie');
  XLSX.writeFile(wb,'financie.xlsx');
}

// graf
function drawChart(){
  const ctx=document.getElementById('chart').getContext('2d');
  const selectedMonth=monthChartSelect.value;
  const filtered=records.filter(r=>r.date.startsWith(selectedMonth));
  const labels=filtered.map(r=>r.item);
  const data_income=filtered.map(r=>r.type==='income'?r.amount:0);
  const data_expense=filtered.map(r=>r.type==='expense'?r.amount:0);
  if(chartInstance) chartInstance.destroy();
  chartInstance=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{label:'Prijmy',data:data_income,backgroundColor:'#00ff99'},{label:'Vydavky',data:data_expense,backgroundColor:'#ff3333'}]},options:{responsive:true,plugins:{legend:{position:'top'}}}});
}

// inicializacia
initSelectors();
render();
renderRecurring();
renderRocny();
</script>
</body>
</html>