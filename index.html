<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rodinne financie</title>

<!-- Ikony pre mobil a favicon -->
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">

<!-- Manifest pre PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3399ff">

<style>
/* Tvoj existujuci styl, tmavy motyv */
body{font-family:Arial,sans-serif;background:#121826;color:#f0f0f0;margin:0;padding:10px}
h1,h2,h3{text-align:center;color:#99ccff;margin:5px 0}
.box{background:#1f2233;padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid #333}
input,select,button{width:100%;padding:8px;margin:5px 0;border-radius:6px;border:1px solid #555;background:#2a2f44;color:#f0f0f0}
button{font-size:16px;background:#3399ff;color:#fff;border:none;cursor:pointer}
button:hover{background:#2277cc}
.income{color:#00ff99;font-weight:bold}
.expense{color:#ff9933;font-weight:bold}
.month-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.month-card{border:1px solid #444;border-radius:10px;padding:10px;background:#2a2f44}
.month-card h4{text-align:center;margin:6px 0;color:#99ccff}
.row{display:flex;justify-content:space-between;gap:10px}
.records-table{display:flex;flex-direction:column;gap:6px}
.record-row{display:flex;gap:6px;align-items:center}
.record-row input, .record-row span{border:1px solid #555;padding:4px;border-radius:4px;background:#2a2f44;color:#f0f0f0}
.record-row input[type=checkbox]{width:20px;height:20px;margin:0}
.record-row span{flex:1;text-align:left}
.record-row span.amount{width:80px;text-align:right}
.actions{margin-top:10px;text-align:right}
.tab{display:flex;cursor:pointer;gap:10px;margin-bottom:10px}
.tab button{flex:1;padding:10px;background:#2a2f44;color:#99ccff;border:none;border-radius:5px}
.tab button.active{background:#3399ff;color:#fff;font-weight:bold}
.tab-content{display:none}
.tab-content.active{display:block}
canvas{max-width:100%;height:300px;background:#1f2233;border-radius:10px}
.autocomplete-input{width:100%;padding:6px;background:#2a2f44;color:#f0f0f0}
.suggestions{border:1px solid #555;background:#2a2f44;position:absolute;z-index:1000;max-height:150px;overflow-y:auto;color:#f0f0f0}
.suggestions div{padding:4px;cursor:pointer}
.suggestions div:hover{background:#505773}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>

<h1>Rodinne financie</h1>

<div class="tab">
  <button class="active" onclick="openTab(event,'prehlad')">Prehlad</button>
  <button onclick="openTab(event,'grafy')">Grafy</button>
</div>

<div id="prehlad" class="tab-content active">
  <!-- Rocny prehlad -->
  <div class="box">
    <h2>Rocny prehlad</h2>
    <select id="yearSelect"></select>
    <div id="yearSummary" class="month-grid"></div>
    <h3>Celkom za rok: <span id="yearTotal">0 EUR</span></h3>
  </div>

  <!-- Pridavanie zaznamu -->
  <div class="box" style="position:relative">
    <h2>Pridat zaznam</h2>
    <input type="date" id="date">
    <select id="type">
      <option value="expense">Vydavok</option>
      <option value="income">Prijem</option>
    </select>
    <select id="category">
      <option>Potraviny</option>
      <option>Najom</option>
      <option>Auto</option>
      <option>Domacnost</option>
      <option>Zdravie</option>
      <option>Sport</option>
      <option>Ostatne</option>
    </select>
    <input type="text" id="itemInput" class="autocomplete-input" placeholder="Polozka">
    <div id="suggestions" class="suggestions" style="display:none"></div>
    <input type="number" id="amount" placeholder="Suma (EUR)">
    <button onclick="saveRecord()">Ulozit</button>
  </div>

  <!-- Mesacny detail -->
  <div class="box">
    <h2>Mesacny detail</h2>
    <select id="monthFilter"></select>
    <div id="records" class="records-table"></div>
    <div class="actions"><button onclick="deleteSelected()">Vymaz oznacene</button></div>
    <button onclick="exportXLSX()">Export do Excel (.xlsx)</button>
  </div>
</div>

<div id="grafy" class="tab-content">
  <div class="box">
    <h2>Graf prijmov a vydavkov</h2>
    <select id="monthChartSelect" onchange="drawChart()"></select>
    <canvas id="chart"></canvas>
  </div>
</div>

<script>
const monthNames=['Januar','Februar','Marec','April','Maj','Jun','Jul','August','September','Oktober','November','December'];
let records=JSON.parse(localStorage.getItem('records'))||[];
let categoryItems=JSON.parse(localStorage.getItem('categoryItems'))||{};
let recurringRecords=JSON.parse(localStorage.getItem('recurringRecords'))||[];
let chartInstance=null;

const yearSelect=document.getElementById('yearSelect');
const monthFilter=document.getElementById('monthFilter');
const yearSummary=document.getElementById('yearSummary');
const yearTotalEl=document.getElementById('yearTotal');
const recordsDiv=document.getElementById('records');
const itemInput=document.getElementById('itemInput');
const suggestionsDiv=document.getElementById('suggestions');
const categorySelect=document.getElementById('category');
const monthChartSelect=document.getElementById('monthChartSelect');

function openTab(evt, tabName){
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.tab button').forEach(b=>b.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  evt.currentTarget.classList.add('active');
  if(tabName==='grafy') drawChart();
}

function saveRecord(){
  const r={date:date.value,type:type.value,category:categorySelect.value,item:itemInput.value,amount:parseFloat(amount.value)};
  if(!r.date||!r.amount||!r.item){alert('Vypln vsetky udaje');return}
  records.push(r);
  if(!categoryItems[r.category]) categoryItems[r.category]=[];
  if(!categoryItems[r.category].includes(r.item)) categoryItems[r.category].push(r.item);
  localStorage.setItem('categoryItems',JSON.stringify(categoryItems));
  amount.value='';itemInput.value='';
  localStorage.setItem('records',JSON.stringify(records));
  initSelectors();
  render();
}

function initSelectors(){
  const years=[...new Set(records.map(r=>r.date.slice(0,4)))].sort();
  if(!years.includes(String(new Date().getFullYear()))) years.push(String(new Date().getFullYear()));
  yearSelect.innerHTML=''; years.forEach(y=>{const o=document.createElement('option'); o.value=y; o.textContent=y; yearSelect.appendChild(o);});
  if(!yearSelect.value) yearSelect.value=String(new Date().getFullYear());

  monthFilter.innerHTML=''; monthChartSelect.innerHTML='';
  for(let m=1;m<=12;m++){
    const monthStr=yearSelect.value+'-'+String(m).padStart(2,'0');
    const o1=document.createElement('option'); o1.value=monthStr; o1.textContent=monthNames[m-1]+' '+yearSelect.value; monthFilter.appendChild(o1);
    const o2=o1.cloneNode(true); monthChartSelect.appendChild(o2);
  }
  monthFilter.value=new Date().toISOString().slice(0,7);
}

yearSelect.onchange=()=>{initSelectors();render();};
monthFilter.onchange=render;

function render(){
  let yearTotal=0;
  yearSummary.innerHTML='';
  for(let i=0;i<12;i++){
    let inc=0,exp=0;
    records.forEach(r=>{const d=new Date(r.date); if(d.getFullYear()===Number(yearSelect.value) && d.getMonth()===i){r.type==='income'?inc+=r.amount:exp+=r.amount;}});
    yearSummary.innerHTML+=`<div class="month-card"><h4>${monthNames[i]}</h4><div class="row"><span>Prijmy</span><span class="income">${inc.toFixed(2)} EUR</span></div><div class="row"><span>Vydavky</span><span class="expense">${exp.toFixed(2)} EUR</span></div></div>`;
    yearTotal+=inc-exp;
  }
  yearTotalEl.innerText=yearTotal.toFixed(2)+' EUR';

  recordsDiv.innerHTML='';
  records.forEach((r,i)=>{
    if(!r.date.startsWith(monthFilter.value)) return;
    const div=document.createElement('div');
    div.className='record-row '+r.type; div.dataset.index=i;
    div.innerHTML=`<input type='checkbox' class='record-check'><span class='desc'>${r.category} - ${r.item}</span><span class='amount'>${r.amount} EUR</span>`;
    recordsDiv.appendChild(div);
  });
}

function deleteSelected(){
  const checkboxes=document.querySelectorAll('#records .record-check');
  const indexesToDelete=[];
  checkboxes.forEach(cb=>{if(cb.checked){indexesToDelete.push(Number(cb.parentElement.dataset.index));}});
  indexesToDelete.sort((a,b)=>b-a).forEach(idx=>{records.splice(idx,1);});
  localStorage.setItem('records',JSON.stringify(records));
  render();
}

function exportXLSX(){
  if(records.length===0){alert('Ziadne zaznamy na export'); return;}
  const wb=XLSX.utils.book_new();
  const ws_data=[['Datum','Typ','Kategorie','Polozka','Suma']];
  records.forEach(r=>ws_data.push([r.date,r.type,r.category,r.item,r.amount]));
  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,'Financie');
  XLSX.writeFile(wb,'financie.xlsx');
}

function drawChart(){
  const ctx=document.getElementById('chart').getContext('2d');
  const selectedMonth=monthChartSelect.value;
  const filtered=records.filter(r=>r.date.startsWith(selectedMonth));
  const labels=filtered.map(r=>r.item);
  const data_income=filtered.map(r=>r.type==='income'?r.amount:0);
  const data_expense=filtered.map(r=>r.type==='expense'?r.amount:0);
  if(chartInstance) chartInstance.destroy();
  chartInstance=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{label:'Prijmy',data:data_income,backgroundColor:'#00ff99'},{label:'Vydavky',data:data_expense,backgroundColor:'#ff9933'}]},options:{responsive:true,plugins:{legend:{position:'top'}}}});
}

initSelectors();
render();
</script>
</body>
</html>